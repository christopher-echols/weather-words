<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Weather Words ‚Äî Ride</title>
  <link href="https://fonts.googleapis.com/css2?family=Quattrocento:wght@700&family=Questrial&display=swap" rel="stylesheet">
  <style>
    :root{
      --accent:#20a2ee;     /* calm blue */
      --accent2:#1ec278;    /* green for callouts */
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:10%;
      min-height:100vh;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      font-family:'Questrial', system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      transition: background-color 420ms ease, color 420ms ease;
    }
    /* Theme palettes (muted) */
    body.theme-neutral{ background:#e9efeF; color:#26364d; }
    body.theme-cool   { background:#dfeaf0; color:#26364d; }
    body.theme-warm   { background:#f3eadf; color:#3b2f2a; }
    body.theme-rain   { background:#e6edf1; color:#22303d; }
    body.theme-snow   { background:#f5f7fa; color:#2c3a4a; }

    .container{width:100%; animation:fadeIn 320ms ease-out both; position:relative}

    /* Controls separated and fixed in the corner */
    .controls{position:fixed; top:12px; right:12px; display:flex; gap:.5rem; align-items:center; opacity:.85; z-index:10}
    .controls:hover{opacity:1}
    .icon-btn{background:none;border:none;cursor:pointer;font-size:1.6rem;color:var(--accent)}
    .mini{appearance:none; background:transparent; border:1px solid rgba(38,54,77,.25); color:inherit;
          padding:.25rem .5rem; border-radius:6px; font-size:.95rem}

    /* Typography hierarchy */
    .wx-icon{font-size:clamp(3rem, 7vw, 4.25rem); line-height:1; margin:0 auto .35rem}
    h1{
      font-family:'Quattrocento', serif; font-weight:700;
      font-size:clamp(2.5rem, 6vw, 4rem); line-height:1.1;
      margin:.1rem 0 1rem; letter-spacing:-0.01em;
      transition: color 420ms ease;
    }
    #weather{
      font-family:'Questrial', sans-serif; font-weight:400;
      font-size:clamp(1.5rem, 4vw, 2.25rem); line-height:1.35;
      max-width:40ch; margin:0 auto 1.25rem; letter-spacing:0.01em;
      transition: color 420ms ease;
    }
    #advice{
      font-family:'Quattrocento', serif; font-weight:700;
      font-size:clamp(1.1rem, 2.5vw, 1.5rem); line-height:1.35;
      margin-top:.75rem; letter-spacing:-0.005em;
      transition: color 420ms ease;
    }
    /* Advice color per theme */
    body.theme-neutral #advice{ color:#1e7f52 }
    body.theme-cool    #advice{ color:#1e7f52 }
    body.theme-warm    #advice{ color:#7d5a3a }
    body.theme-rain    #advice{ color:#1e6a7f }
    body.theme-snow    #advice{ color:#315a7d }

    /* Manual location popover separated from layout */
    #locationInputContainer{display:none; position:fixed; top:52px; right:12px; background:#ffffffd9; color:#111; padding:.75rem; border-radius:8px; box-shadow:0 6px 24px rgba(0,0,0,.12); width:min(80vw,320px); text-align:left; z-index:11}
    #locationInputContainer input{width:100%; padding:.5rem .6rem; font-size:1rem; margin:.25rem 0 .5rem;}
    #locationInputContainer button{background:var(--accent2); color:white; border:none; border-radius:6px; padding:.45rem .7rem; font-size:1rem; cursor:pointer}

    @media (max-width: 480px){
      h1{font-size:clamp(2rem, 8vw, 2.6rem)}
      #weather{font-size:clamp(1.25rem, 5vw, 1.9rem)}
    }

    @keyframes fadeIn{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:none}}
  </style>
</head>
<body>
  <!-- Fixed controls in the upper right -->
  <div class="controls">
    <select id="headingSelect" class="mini" title="Outbound heading">
      <option value="none">Heading</option>
      <option value="0">N</option>
      <option value="45">NE</option>
      <option value="90">E</option>
      <option value="135">SE</option>
      <option value="180">S</option>
      <option value="225">SW</option>
      <option value="270">W</option>
      <option value="315">NW</option>
    </select>
    <select id="routeType" class="mini" title="Route">
      <option value="outback" selected>Out & Back</option>
      <option value="loop">Loop</option>
    </select>
    <button class="icon-btn" onclick="toggleLocationInput()" title="Set location">üìç</button>
  </div>

  <div class="container">
    <div id="wxIcon" class="wx-icon" aria-hidden="true">‚òÄÔ∏è</div>
    <h1 id="summary">Loading...</h1>
    <div id="weather">Loading weather‚Ä¶</div>
    <div id="advice" class="advice"></div>
  </div>

  <!-- Detached manual location popover -->
  <div id="locationInputContainer">
    <label for="locationInput" style="font-size:.9rem;opacity:.8">Enter a city</label>
    <input id="locationInput" type="text" placeholder="e.g., Knoxville" />
    <button onclick="fetchWeatherByCity()">Use this location</button>
  </div>

  <script>
    /* --- Condition map --- */
    const WX = {
      0:{desc:'clear sky', icon:'‚òÄÔ∏è'}, 1:{desc:'mostly clear', icon:'üå§Ô∏è'}, 2:{desc:'partly cloudy', icon:'‚õÖ'}, 3:{desc:'overcast', icon:'‚òÅÔ∏è'},
      45:{desc:'foggy', icon:'üå´Ô∏è'}, 48:{desc:'dense fog', icon:'üå´Ô∏è'},
      51:{desc:'light drizzle', icon:'üå¶Ô∏è'}, 53:{desc:'drizzle', icon:'üå¶Ô∏è'}, 55:{desc:'heavy drizzle', icon:'üåßÔ∏è'},
      61:{desc:'light rain', icon:'üåßÔ∏è'}, 63:{desc:'rain', icon:'üåßÔ∏è'}, 65:{desc:'heavy rain', icon:'‚õàÔ∏è'},
      71:{desc:'light snow', icon:'üå®Ô∏è'}, 73:{desc:'snow', icon:'‚ùÑÔ∏è'}, 75:{desc:'heavy snow', icon:'‚ùÑÔ∏è'},
      95:{desc:'thunderstorms', icon:'‚õàÔ∏è'}
    };
    const $ = s => document.querySelector(s);

    let lastData = null; // cache latest to recompute on heading change

    function toggleLocationInput(){
      const box = $('#locationInputContainer');
      box.style.display = (box.style.display === 'block') ? 'none' : 'block';
    }

    function degDiff(a,b){
      const d = Math.abs(((a - b + 540) % 360) - 180);
      return d; // 0..180
    }

    function bearingToText(b){
      const dirs = ['N','NE','E','SE','S','SW','W','NW'];
      const idx = Math.round(b/45) % 8; return dirs[idx];
    }

    function relationship(windFromDeg, riderHeadingDeg){
      if (riderHeadingDeg == null || isNaN(riderHeadingDeg)) return {kind:'wind', label:'wind'};
      const diff = degDiff(windFromDeg, riderHeadingDeg);
      if (diff <= 45) return {kind:'head', label:'headwind'};
      if (diff >= 135) return {kind:'tail', label:'tailwind'};
      return {kind:'cross', label:'crosswind'};
    }

    function mph(kmh){ return Math.round(kmh / 1.609); }
    function fFromC(c){ return Math.round(c * 9/5 + 32); }

    function periodLabel(hour){
      if (hour>=5 && hour<=11) return 'this morning';
      if (hour>=12 && hour<=16) return 'this afternoon';
      if (hour>=17 && hour<=21) return 'this evening';
      return 'overnight';
    }

    function categoryFor(code){
      if ([51,53,55].includes(code)) return 'drizzle';
      if ([61,63,65].includes(code)) return 'rain';
      if ([71,73,75].includes(code)) return 'snow';
      if ([95].includes(code)) return 'storm';
      if ([45,48].includes(code)) return 'fog';
      if ([0,1,2,3].includes(code)) return 'dry';
      return 'other';
    }

    function summarizeNextSix(hourly, startIdx){
      const times = hourly.time; const codes = hourly.weathercode; const temps = hourly.temperature_2m; const gusts = hourly.windgusts_10m;
      if (!times || startIdx<0) return '';
      const endIdx = Math.min(startIdx+6, times.length);
      const sliceCodes = codes.slice(startIdx, endIdx);
      const sliceTemps = temps.slice(startIdx, endIdx);
      const sliceGusts = (gusts||[]).slice(startIdx, endIdx);
      const firstHour = new Date(times[startIdx]).getHours();

      const firstDrizzle = sliceCodes.findIndex(c=>categoryFor(c)==='drizzle');
      const firstRain    = sliceCodes.findIndex(c=>categoryFor(c)==='rain');
      const firstSnow    = sliceCodes.findIndex(c=>categoryFor(c)==='snow');
      const firstStorm   = sliceCodes.findIndex(c=>categoryFor(c)==='storm');
      const precipTuples = [
        {t:'thunderstorms', i:firstStorm}, {t:'snow', i:firstSnow}, {t:'rain', i:firstRain}, {t:'light rain', i:firstDrizzle}
      ].filter(x=>x.i!==-1).sort((a,b)=>a.i-b.i);

      const firstF = fFromC(sliceTemps[0]);
      const lastF  = fFromC(sliceTemps[sliceTemps.length-1]);
      const delta  = lastF-firstF;

      function whenPhrase(offset){ if (offset<=1) return 'soon'; const hr=(firstHour+offset)%24; return 'by '+periodLabel(hr); }

      if (precipTuples.length){
        const {t,i} = precipTuples[0];
        const verb = (i<=1)?'is likely':'is expected';
        return `${t.charAt(0).toUpperCase()+t.slice(1)} ${verb} ${whenPhrase(i)}.`;
      }
      if (Math.abs(delta)>=4){ return (delta>0)?'Temperatures will climb a bit over the next few hours.':'Temperatures will ease down over the next few hours.'; }
      if (sliceGusts.length>=2){
        const g0 = Math.round(sliceGusts[0]||0), g1 = Math.round(sliceGusts[sliceGusts.length-1]||0);
        if (g1-g0 >= 5) return 'Gusts will strengthen a little in the next few hours.';
        if (g0-g1 >= 5) return 'Gusts will ease a little over the next few hours.';
      }
      return 'It should stay fairly steady and dry for a while.';
    }

    function routeHint(kind, routeType){
      if(routeType!=='outback') return '';
      if(kind==='head') return ' Tailwind on the way back.';
      if(kind==='tail') return ' Headwind on the return.';
      if(kind==='cross') return ' Crosswind both ways.';
      return '';
    }

    function adviceSentence(nowF, feelF, windKind, windMph, nextPrecipLikely){
      const parts=[];
      if (nextPrecipLikely) parts.push('Pack a light shell');
      if (feelF<=50 || (nowF<58 && windMph>=10)) parts.push('An extra light layer will keep you warm enough');
      if (nowF>=85 || feelF>=88) parts.push('Bring extra water and a pinch of electrolytes');
      if (windKind==='cross' && windMph>=15) parts.push('Watch for crosswind gusts on open sections');
      if(!parts.length) return 'Wear whatever‚Äôs comfortable ‚Äî standard kit is perfect today.';
      return parts.join('. ') + '.';
    }

    function chooseTheme(tempF, code){
      const cat = categoryFor(code);
      if (cat==='snow') return 'theme-snow';
      if (cat==='rain' || cat==='drizzle' || cat==='storm') return 'theme-rain';
      if (tempF >= 80) return 'theme-warm';
      if (tempF <= 50) return 'theme-cool';
      return 'theme-neutral';
    }

    function applyTheme(theme){
      const classes = ['theme-neutral','theme-cool','theme-warm','theme-rain','theme-snow'];
      classes.forEach(c => document.body.classList.remove(c));
      document.body.classList.add(theme);
    }

    function render(data){
      const wEl = $('#weather'); const sEl = $('#summary'); const aEl = $('#advice'); const iEl = $('#wxIcon');
      if(!data || !data.current_weather){ sEl.textContent=''; wEl.textContent='Weather data not available.'; aEl.textContent=''; iEl.textContent=''; return; }

      const tempF = fFromC(data.current_weather.temperature);
      const windMph = mph(data.current_weather.windspeed);
      const windFrom = data.current_weather.winddirection;
      const code = data.current_weather.weathercode; const meta = WX[code] || {desc:'weather', icon:''};

      // THEME ‚Äî set based on conditions and temp (with CSS transition)
      applyTheme(chooseTheme(tempF, code));

      let idx = (data.hourly?.time||[]).findIndex(t => new Date(t).getTime() > Date.now());
      if (idx===-1) idx = 0; const curIdx = Math.max(0, idx-1);
      const feelF = fFromC((data.hourly?.apparent_temperature||[])[curIdx] ?? data.current_weather.temperature);
      const gustNow = Math.round((data.hourly?.windgusts_10m||[])[curIdx] || windMph);

      const headingVal = parseInt($('#headingSelect').value,10);
      const rel = relationship(windFrom, isNaN(headingVal)? null : headingVal);

      // Icon above headline
      iEl.textContent = meta.icon || '';

      // Headline (cyclist flavor)
      let headline;
      if (tempF >= 90) headline = "It‚Äôs hot with a "+(rel.label);
      else if (tempF >= 75) headline = "It‚Äôs warm with a "+(rel.label);
      else if (tempF >= 60) headline = "It‚Äôs mild with a "+(rel.label);
      else if (tempF >= 45) headline = "It‚Äôs cool with a "+(rel.label);
      else headline = "It‚Äôs chilly with a "+(rel.label);
      sEl.textContent = headline;

      // Next‚Äë6h single sentence
      let nextSentence = '';
      if (data.hourly && idx>=0){ nextSentence = summarizeNextSix(data.hourly, idx); }

      // Precip likely soon flag for advice
      let nextPrecipLikely = false;
      if (data.hourly && idx>=0){
        const codes = data.hourly.weathercode.slice(idx, Math.min(idx+6, data.hourly.weathercode.length));
        nextPrecipLikely = codes.some(c => ['drizzle','rain','snow','storm'].includes(categoryFor(c)));
      }

      const route = $('#routeType').value;
      const windText = `${windMph} mph ${rel.label} from the ${bearingToText(windFrom)}` + (gustNow>windMph?`; gusts to ${gustNow}`:'');
      const hint = routeHint(rel.kind, route);
      const nowSentence = `Right now it‚Äôs ${tempF}¬∞ (feels ${feelF}¬∞) and ${meta.desc}, with ${windText}.${hint ? ' '+hint : ''}`;

      wEl.textContent = `${nowSentence} ${nextSentence}`.trim();
      aEl.textContent = adviceSentence(tempF, feelF, rel.kind, windMph, nextPrecipLikely);

      lastData = data;
    }

    function fetchWeather(lat, lon){
      const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,apparent_temperature,weathercode,windgusts_10m`;
      fetch(url).then(r=>r.json()).then(render).catch(()=>{
        $('#weather').textContent='Error fetching weather.';
      });
    }

    function fetchWeatherByCity(){
      const city = $('#locationInput').value.trim(); if(!city) return;
      const geoUrl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(city)}&count=1`;
      fetch(geoUrl).then(r=>r.json()).then(d=>{
        if(d && d.results && d.results.length){ const loc=d.results[0]; fetchWeather(loc.latitude, loc.longitude); toggleLocationInput(); }
        else { $('#weather').textContent='Location not found.'; }
      }).catch(()=> $('#weather').textContent='Error finding location.');
    }

    if(navigator.geolocation){
      navigator.geolocation.getCurrentPosition(
        pos => fetchWeather(pos.coords.latitude, pos.coords.longitude),
        () => { $('#weather').textContent='Location permission denied. Tap the pin to enter a city.'; }
      );
    } else { $('#weather').textContent='Geolocation not supported. Tap the pin to enter a city.'; }

    ['headingSelect','routeType'].forEach(id=>{
      document.addEventListener('change', e=>{
        if(e.target && e.target.id===id && lastData){ render(lastData); }
      });
    });
  </script>
</body>
</html>
